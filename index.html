<!DOCTYPE html><html lang="id"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="theme-color" content="#16a34a"/><link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon-192.png"><title>Stock Opname â€“ PWA (Autoâ€‘Sync)</title>
<style>:root{--bg:#f7f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#16a34a;--danger:#dc2626;--warn:#d97706;--radius:16px;--shadow:0 8px 24px rgba(0,0,0,.08)}*{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}body{margin:0;background:var(--bg);color:var(--text)}.container{max-width:960px;margin:24px auto;padding:16px}h1{font-size:22px;margin:8px 0 12px}.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:14px}label{display:block;font-weight:600;margin:10px 0 6px}input,select,textarea{width:100%;padding:14px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px;outline:none}.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}.btn{appearance:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:12px;background:var(--primary);color:#fff;border:none;font-weight:700;cursor:pointer;transition:.15s;box-shadow:0 6px 16px rgba(22,163,74,.35)}.btn:hover{filter:brightness(1.05)}.btn:disabled{opacity:.6;cursor:not-allowed}.btn-ghost{background:#eef7f0;color:#065f46}.btn-danger{background:var(--danger)}.btn-warn{background:#fef3c7;color:#92400e;border:1px solid #fde68a}.muted{color:var(--muted);font-size:12px}.preview{background:#0b141a;color:#e8f0f7;border-radius:12px;padding:12px;font-family:ui-monospace,Menlo,Consolas;white-space:pre-wrap;min-height:120px}.table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:12px;border:1px solid #e5e7eb}.table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left;font-size:14px;white-space:nowrap}.table th{font-size:12px;color:#374151}.date-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.date-row .btn{padding:10px 12px}.date-shell{width:100%;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb;background:#fff}input[type=date]{appearance:none;-webkit-appearance:none;border:none;width:100%;padding:14px 12px;background:#fff;border-radius:0;font-size:16px;line-height:1.3}input[type=date]::-webkit-date-and-time-value{min-width:100%;height:1.2em}input[type=date]::-webkit-calendar-picker-indicator{padding:6px;margin-right:2px}.statusbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.badge{font-size:12px;border-radius:999px;padding:6px 10px}.badge.off{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}.badge.on{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}.badge.sync{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}@media (max-width:720px){.row{grid-template-columns:1fr}}@media (max-width:540px){.row3{grid-template-columns:1fr}.container{padding:12px}input,select,textarea{font-size:16px;padding:14px}.btn{width:100%}.date-row{flex-direction:column;align-items:stretch}}</style>
</head><body><div class="container"><h1>Stock Opname â€“ PWA (Autoâ€‘Sync)</h1><p class="muted">Offline dulu, auto-sync ke Google Sheets saat online. Prefill lintas perangkat via cloud.</p>
<section class="card"><h2 style="margin:0 0 10px;font-size:18px">Pengaturan</h2>
<div class="row"><div><label>Google Apps Script Web App URL</label><input id="baseUrl" placeholder="https://script.google.com/macros/s/AKfycbx.../exec"/></div>
<div><label>API Key</label><input id="apiKey" placeholder="AUTH_KEY dari Apps Script"/></div></div>
<div class="row"><div><label>Nama Outlet/Kasir (opsional)</label><input id="byName" placeholder="misal: Sunflour Bites - Kasir A"/></div>
<div><label>Nomor WA Admin (62812â€¦ tanpa +)</label><input id="adminNumber" value="6281234567890" inputmode="numeric"/></div></div>
<div class="statusbar"><button class="btn" id="saveSettings" type="button">Simpan Pengaturan</button><span id="netBadge" class="badge off">Offline</span><span id="syncBadge" class="badge sync">Outbox: 0</span></div>
<p class="muted" style="margin-top:6px">Pengaturan disimpan di perangkat ini. Outbox menampung kiriman yang tertunda & otomatis dikirim saat online.</p></section>
<section class="card"><label>Tanggal</label><div class="date-row"><div class="date-shell"><input id="tanggal" type="date"/></div>
<button class="btn btn-ghost" id="prefillYesterday" type="button">â¬‡ Prefill dari Kemarin (Cloud)</button>
<button class="btn btn-ghost" id="seedYesterday" type="button" title="Testing lokal">ðŸ§ª Dummy Kemarin (Lokal)</button></div></section>
<section class="card"><h2 style="margin:0 0 10px;font-size:18px">Input Item</h2><label>Nama Barang</label>
<select id="namaBarang"><option value="Cup 14 oz">Cup 14 oz</option><option value="Cup 16 oz">Cup 16 oz</option><option value="Sedotan">Sedotan</option><option value="Paper Packaging">Paper Packaging</option><option value="Box M">Box M</option><option value="Box L">Box L</option></select>
<div class="row3"><div><label>Stok Awal</label><input id="stokAwal" type="number" min="0" value="0"/></div>
<div><label>Stock In (Restock)</label><input id="stokMasuk" type="number" min="0" value="0"/></div>
<div><label>Terjual</label><input id="terjual" type="number" min="0" value="0"/></div></div>
<div class="row"><div><label>Stok Akhir (otomatis)</label><input id="stokAkhir" type="number" readonly/></div>
<div><label>Catatan (opsional)</label><input id="catatan" placeholder="misal: 2 pcs rusak"/></div></div>
<div class="row"><button class="btn" id="addToDraft" type="button">+ Add ke Draft</button><button class="btn btn-ghost" id="resetForm" type="button">Reset Input</button></div></section>
<section class="card"><h2 style="margin:0 0 10px;font-size:18px">Draft Hari Ini</h2><div class="table-wrap"><table class="table" id="draftTable"><thead><tr><th>Barang</th><th>Awal</th><th>Masuk</th><th>Terjual</th><th>Akhir</th><th>Catatan</th><th></th></tr></thead><tbody></tbody></table></div>
<label>Preview pesan WhatsApp</label><pre class="preview" id="waPreview"></pre>
<div class="row"><button class="btn btn-ghost" id="saveCloud" type="button">Simpan ke Sheet (Cloud)</button><button class="btn btn-warn" id="queueCloud" type="button">Antrikan ke Outbox</button><button class="btn" id="sendWA" type="button">Kirim ke WhatsApp</button></div></section></div>
<div class="toast" id="toast"></div>
<script>
const $=q=>document.querySelector(q);const keyForDate=d=>`so_draft_${d}`;const keyPrefill=d=>`so_prefill_${d}`;const KEY_OUTBOX='so_outbox_v11';
function todayISO(){return new Date().toISOString().slice(0,10)}function prevISO(s){const d=new Date(s);d.setDate(d.getDate()-1);return d.toISOString().slice(0,10)}
function toast(msg,type='info'){const t=$('#toast');t.textContent=msg;t.style.background=(type==='ok')?'#065f46':(type==='error')?'#991b1b':(type==='warn')?'#92400e':'#111827';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800)}
function loadSettings(){return{baseUrl:localStorage.getItem('so_baseUrl')||'',apiKey:localStorage.getItem('so_apiKey')||'',byName:localStorage.getItem('so_byName')||'',admin:localStorage.getItem('so_admin')||'6281234567890'}}function saveSettings(o){localStorage.setItem('so_baseUrl',o.baseUrl||'');localStorage.setItem('so_apiKey',o.apiKey||'');localStorage.setItem('so_byName',o.byName||'');localStorage.setItem('so_admin',o.admin||'')}
function updateNetBadge(){const b=$('#netBadge');if(navigator.onLine){b.textContent='Online';b.className='badge on'}else{b.textContent='Offline';b.className='badge off'}}window.addEventListener('online',()=>{updateNetBadge();tryAutoSync()});window.addEventListener('offline',updateNetBadge);updateNetBadge();
function getOutbox(){try{return JSON.parse(localStorage.getItem(KEY_OUTBOX)||'[]')}catch{return[]}}function setOutbox(a){localStorage.setItem(KEY_OUTBOX,JSON.stringify(a));updateSyncBadge()}function pushOutbox(i){const a=getOutbox();a.push(i);setOutbox(a)}function updateSyncBadge(){const n=getOutbox().length;$('#syncBadge').textContent='Outbox: '+n}
function renderSettings(){const s=loadSettings();$('#baseUrl').value=s.baseUrl;$('#apiKey').value=s.apiKey;$('#byName').value=s.byName;$('#adminNumber').value=s.admin}
$('#saveSettings').addEventListener('click',()=>{saveSettings({baseUrl:$('#baseUrl').value.trim(),apiKey:$('#apiKey').value.trim(),byName:$('#byName').value.trim(),admin:$('#adminNumber').value.replace(/[^0-9]/g,'')});toast('Pengaturan disimpan','ok')})
$('#tanggal').value=todayISO();$('#tanggal').addEventListener('change',()=>{loadDraft();buildPreview();prefillMap=loadPrefillMap();applyPrefillToFormIfEmpty()})
const state={items:new Map()};function loadDraft(){state.items.clear();const raw=localStorage.getItem(keyForDate($('#tanggal').value));if(raw){try{const obj=JSON.parse(raw);for(const k of Object.keys(obj))state.items.set(k,obj[k])}catch(e){}}renderTable()}
function saveDraft(){const obj={};for(const[ k,v] of state.items.entries())obj[k]=v;localStorage.setItem(keyForDate($('#tanggal').value),JSON.stringify(obj))}
function renderTable(){const tb=$('#draftTable tbody');tb.innerHTML='';for(const[name,obj]of state.items.entries()){const tr=document.createElement('tr');tr.innerHTML=`<td>${name}</td><td>${obj.awal}</td><td>${obj.masuk}</td><td>${obj.jual}</td><td>${obj.akhir}</td><td>${obj.note||''}</td><td><button class="btn btn-danger" data-del="${name}" type="button">Hapus</button></td>`;tb.appendChild(tr)}tb.querySelectorAll('button[data-del]').forEach(btn=>btn.addEventListener('click',e=>{const nm=e.currentTarget.getAttribute('data-del');state.items.delete(nm);renderTable();buildPreview();saveDraft()}))}
function calcAkhir(){const a=Number($('#stokAwal').value||0),m=Number($('#stokMasuk').value||0),j=Number($('#terjual').value||0);$('#stokAkhir').value=Math.max(a+m-j,0)}['stokAwal','stokMasuk','terjual'].forEach(id=>$('#'+id).addEventListener('input',calcAkhir));$('#namaBarang').addEventListener('change',applyPrefillToFormIfEmpty)
function buildPreview(){const tgl=$('#tanggal').value||todayISO();let lines=['Stock Opname',`Tanggal: ${tgl}`,''];for(const[name,obj]of state.items.entries()){lines.push(`Barang: ${name}`);lines.push(`Stok Awal: ${obj.awal}`);lines.push(`Restock: ${obj.masuk}`);lines.push(`Terjual: ${obj.jual}`);lines.push(`Stok Akhir: ${obj.akhir}`);lines.push('')}$('#waPreview').textContent=lines.join('\n')}
$('#addToDraft').addEventListener('click',()=>{const name=$('#namaBarang').value.trim();const awal=Number($('#stokAwal').value||0);const masuk=Number($('#stokMasuk').value||0);const jual=Number($('#terjual').value||0);const akhir=Math.max(awal+masuk-jual,0);const note=$('#catatan').value.trim();if(!name){toast('Pilih nama barang','error');return}if(state.items.has(name)){toast('Barang sudah ada di draft','error');return}state.items.set(name,{awal,masuk,jual,akhir,note});renderTable();buildPreview();saveDraft();toast('Ditambahkan ke draft','ok')})
$('#resetForm').addEventListener('click',()=>{$('#stokAwal').value=0;$('#stokMasuk').value=0;$('#terjual').value=0;$('#catatan').value='';calcAkhir()})
let prefillMap={};function loadPrefillMap(){const raw=localStorage.getItem(keyPrefill($('#tanggal').value));try{return raw?JSON.parse(raw):{}}catch{return{}}}
function applyPrefillToFormIfEmpty(){const sel=$('#namaBarang').value;if(Number($('#stokAwal').value||0)===0&&prefillMap&&prefillMap[sel]!=null){$('#stokAwal').value=prefillMap[sel];calcAkhir();toast('Stok Awal diisi dari stok akhir kemarin','ok')}}
async function fetchYesterdayFromCloud(todayISO){const s=loadSettings();if(!s.baseUrl||!s.apiKey)throw new Error('Pengaturan belum diisi');const url=s.baseUrl+'?action=yesterday&date='+encodeURIComponent(todayISO)+'&key='+encodeURIComponent(s.apiKey);const res=await fetch(url,{method:'GET'});const json=await res.json();if(!json.ok)throw new Error(json.error||'Fetch error');return json.data||{}}
$('#prefillYesterday').addEventListener('click',async()=>{try{const map=await fetchYesterdayFromCloud($('#tanggal').value);localStorage.setItem(keyPrefill($('#tanggal').value),JSON.stringify(map));prefillMap=map;applyPrefillToFormIfEmpty();toast('Prefill siap dari cloud','ok')}catch(e){toast('Gagal prefill (cek pengaturan/koneksi).','error')}})
$('#seedYesterday').addEventListener('click',()=>{const y=prevISO($('#tanggal').value);localStorage.setItem(keyForDate(y),JSON.stringify({"Cup 14 oz":{awal:50,masuk:0,jual:2,akhir:48,note:""},"Cup 16 oz":{awal:42,masuk:3,jual:1,akhir:44,note:""},"Sedotan":{awal:248,masuk:10,jual:5,akhir:253,note:""}}));toast('Dummy kemarin tersimpan lokal','ok')})
async function saveTodayToCloud(dateISO,items){const s=loadSettings();if(!s.baseUrl||!s.apiKey)throw new Error('Pengaturan belum lengkap');const res=await fetch(s.baseUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:s.apiKey,date:dateISO,items,by:s.byName||''})});const json=await res.json();if(!json.ok)throw new Error(json.error||'Save error');return json.saved}
function makeItemsArray(){return Array.from(state.items.entries()).map(([name,v])=>({name,awal:v.awal,masuk:v.masuk,jual:v.jual,akhir:v.akhir,note:v.note||''}))}
async function tryAutoSync(){updateNetBadge();if(!navigator.onLine)return;const queue=getOutbox();if(queue.length===0)return;$('#syncBadge').textContent='Outbox: '+queue.length+' (syncing...)';let ok=0,fail=[];for(let i=0;i<queue.length;i++){const item=queue[i];try{await saveTodayToCloud(item.date,item.items);ok++}catch(e){fail.push(item)}}setOutbox(fail);if(ok>0)toast(`Autoâ€‘sync: ${ok} kiriman berhasil`,'ok');if(fail.length>0)toast(`Autoâ€‘sync: ${fail.length} gagal, akan dicoba lagi`,'warn');updateSyncBadge()}
$('#saveCloud').addEventListener('click',async()=>{const items=makeItemsArray();if(items.length===0){toast('Draft kosong','error');return}try{const saved=await saveTodayToCloud($('#tanggal').value,items);toast(`Tersimpan ke Sheet: ${saved} baris`,'ok')}catch(e){pushOutbox({date:$('#tanggal').value,items,ts:Date.now()});toast('Offline/eror. Data dimasukkan ke Outbox.','warn')}})
$('#queueCloud').addEventListener('click',()=>{const items=makeItemsArray();if(items.length===0){toast('Draft kosong','error');return}pushOutbox({date:$('#tanggal').value,items,ts:Date.now()});toast('Ditambahkan ke Outbox. Akan terkirim saat online.','ok')})
function openWhatsApp(num,msg){const e=encodeURIComponent(msg);const url1=`https://api.whatsapp.com/send?phone=${num}&text=${e}`;const url2=`https://wa.me/${num}?text=${e}`;try{window.location.href=url1}catch(_){window.location.href=url2}}
$('#sendWA').addEventListener('click',()=>{const num=$('#adminNumber').value.replace(/[^0-9]/g,'');if(!num){toast('Nomor WA admin kosong','error');return}openWhatsApp(num,$('#waPreview').textContent)})
if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}))}
renderSettings();loadDraft();prefillMap=loadPrefillMap();applyPrefillToFormIfEmpty();buildPreview();updateSyncBadge();tryAutoSync();setInterval(tryAutoSync,15000);
</script></body></html>
