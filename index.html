<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <title>Stock Opname – Super Simpel</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#16a34a;--danger:#dc2626;--radius:16px;--shadow:0 8px 24px rgba(0,0,0,.08)}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:24px auto;padding:16px}
    h1{font-size:22px;margin:8px 0 12px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:14px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px;outline:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{appearance:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:12px;background:var(--primary);color:#fff;border:none;font-weight:700;cursor:pointer;transition:.15s;box-shadow:0 6px 16px rgba(22,163,74,.35)}
    .btn:hover{filter:brightness(1.05)}
    .btn-ghost{background:#eef7f0;color:#065f46}
    .btn-danger{background:var(--danger)}
    .muted{color:var(--muted);font-size:12px}
    .preview{background:#0b141a;color:#e8f0f7;border-radius:12px;padding:12px;font-family:ui-monospace,Menlo,Consolas;white-space:pre-wrap;min-height:120px}
    .table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:12px;border:1px solid #e5e7eb}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left;font-size:14px;white-space:nowrap}
    .table th{font-size:12px;color:#374151}
    .date-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 720px){ .row{grid-template-columns:1fr} .date-row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Stock Opname – Super Simpel</h1>
    <p class="muted">Satu HP saja. Semua data disimpan lokal. Prefill dari kemarin (lokal). WhatsApp ke admin permanen.</p>

    <section class="card">
      <div class="date-row">
        <div>
          <label>Tanggal</label>
          <input id="tanggal" type="date" />
        </div>
        <div>
          <label>Nama Staff (By)</label>
          <input id="byName" placeholder="misal: Kasir A" />
          <p class="muted">Akan muncul di pesan WA.</p>
        </div>
      </div>
      <button class="btn btn-ghost" id="prefillLocal" type="button">⬇ Prefill dari Kemarin (Lokal)</button>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px;font-size:18px">Input Item</h2>
      <label>Nama Barang</label>
      <select id="namaBarang">
        <option value="Cup 14 oz">Cup 14 oz</option>
        <option value="Cup 16 oz">Cup 16 oz</option>
        <option value="Sedotan">Sedotan</option>
        <option value="Paper Packaging">Paper Packaging</option>
        <option value="Box M">Box M</option>
        <option value="Box L">Box L</option>
      </select>

      <div class="row3">
        <div>
          <label>Stok Awal</label>
          <input id="stokAwal" type="number" min="0" value="0" />
        </div>
        <div>
          <label>Stock In (Restock)</label>
          <input id="stokMasuk" type="number" min="0" value="0" />
        </div>
        <div>
          <label>Terjual</label>
          <input id="terjual" type="number" min="0" value="0" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Stok Akhir (otomatis)</label>
          <input id="stokAkhir" type="number" readonly />
        </div>
        <div>
          <label>Catatan (opsional)</label>
          <input id="catatan" placeholder="misal: 2 pcs rusak" />
        </div>
      </div>

      <div class="row">
        <button class="btn" id="addToDraft" type="button">+ Add ke Draft</button>
        <button class="btn btn-ghost" id="resetForm" type="button">Reset Input</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px;font-size:18px">Draft Hari Ini</h2>
      <div class="table-wrap">
        <table class="table" id="draftTable">
          <thead>
            <tr><th>Barang</th><th>Awal</th><th>Masuk</th><th>Terjual</th><th>Akhir</th><th>Catatan</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <label>Preview pesan WhatsApp</label>
      <pre class="preview" id="waPreview"></pre>

      <div class="row">
        <button class="btn" id="sendWA" type="button">Kirim ke WhatsApp</button>
        <button class="btn btn-danger" id="clearDay" type="button">Hapus Draft Tanggal Ini</button>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const ADMIN_NUMBER = "6282147211835";

    const $ = q => document.querySelector(q);
    const keyForDate = d => `so_draft_${d}`;
    const keyPrefill = d => `so_prefill_${d}`;
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function prevISO(s){ const d=new Date(s); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }

    const state = { items:new Map() };

    function loadDraft(){ state.items.clear(); const raw=localStorage.getItem(keyForDate(document.getElementById('tanggal').value)); if(raw){ try{ const obj=JSON.parse(raw); for(const k of Object.keys(obj)) state.items.set(k,obj[k]); }catch(e){} } renderTable(); }
    function saveDraft(){ const obj={}; for(const [k,v] of state.items.entries()) obj[k]=v; localStorage.setItem(keyForDate(document.getElementById('tanggal').value), JSON.stringify(obj)); }
    function renderTable(){ const tb=document.querySelector('#draftTable tbody'); tb.innerHTML=''; for(const [name,obj] of state.items.entries()){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${name}</td><td>${obj.awal}</td><td>${obj.masuk}</td><td>${obj.jual}</td><td>${obj.akhir}</td><td>${obj.note||''}</td><td><button class='btn btn-danger' data-del='${name}' type='button'>Hapus</button></td>`; tb.appendChild(tr); } tb.querySelectorAll('button[data-del]').forEach(btn=>btn.addEventListener('click',e=>{ const nm=e.currentTarget.getAttribute('data-del'); state.items.delete(nm); renderTable(); buildPreview(); saveDraft(); })); }
    function calcAkhir(){ const a=Number(document.getElementById('stokAwal').value||0); const m=Number(document.getElementById('stokMasuk').value||0); const j=Number(document.getElementById('terjual').value||0); document.getElementById('stokAkhir').value=Math.max(a+m-j,0); }
    function buildPreview(){ const tgl=document.getElementById('tanggal').value||todayISO(); const by=document.getElementById('byName').value||''; let lines=['Stock Opname',`Tanggal: ${tgl}`, by?`By: ${by}`:'','']; for(const [name,obj] of state.items.entries()){ lines.push(`Barang: ${name}`); lines.push(`Stok Awal: ${obj.awal}`); lines.push(`Restock: ${obj.masuk}`); lines.push(`Terjual: ${obj.jual}`); lines.push(`Stok Akhir: ${obj.akhir}`); if(obj.note) lines.push(`Catatan: ${obj.note}`); lines.push(''); } document.getElementById('waPreview').textContent=lines.join('\n'); }
    function openWhatsApp(num,msg){ const e=encodeURIComponent(msg); const url1=`https://api.whatsapp.com/send?phone=${num}&text=${e}`; const url2=`https://wa.me/${num}?text=${e}`; try{ window.location.href=url1 }catch(_ ){ window.location.href=url2 } }

    document.getElementById('tanggal').value = todayISO();
    document.getElementById('tanggal').addEventListener('change', ()=>{ loadDraft(); buildPreview(); });

    ['stokAwal','stokMasuk','terjual'].forEach(id=>document.getElementById(id).addEventListener('input', calcAkhir));
    document.getElementById('namaBarang').addEventListener('change', ()=>{ const sel=document.getElementById('namaBarang').value; if(Number(document.getElementById('stokAwal').value||0)===0){ const map=loadPrefillMap(); if(map && map[sel]!=null){ document.getElementById('stokAwal').value=map[sel]; calcAkhir(); } } });

    function loadPrefillMap(){ const raw=localStorage.getItem(keyPrefill(document.getElementById('tanggal').value)); try{ return raw?JSON.parse(raw):{}; }catch{ return {}; } }
    document.getElementById('prefillLocal').addEventListener('click', ()=>{ const y=prevISO(document.getElementById('tanggal').value); const raw=localStorage.getItem(keyForDate(y)); if(!raw){ alert('Belum ada data kemarin di HP ini'); return; } try{ const obj=JSON.parse(raw); const map={}; Object.keys(obj).forEach(k=>map[k]=obj[k].akhir||0); localStorage.setItem(keyPrefill(document.getElementById('tanggal').value), JSON.stringify(map)); alert('Prefill siap (lokal). Pilih barang → Stok Awal otomatis.'); }catch(e){ alert('Prefill gagal'); } });

    document.getElementById('addToDraft').addEventListener('click', ()=>{ const name=document.getElementById('namaBarang').value.trim(); const awal=Number(document.getElementById('stokAwal').value||0); const masuk=Number(document.getElementById('stokMasuk').value||0); const jual=Number(document.getElementById('terjual').value||0); const akhir=Math.max(awal+masuk-jual,0); const note=document.getElementById('catatan').value.trim(); if(!name){ alert('Pilih nama barang'); return; } if(state.items.has(name)){ alert('Barang sudah ada di draft'); return; } state.items.set(name,{awal,masuk,jual,akhir,note}); renderTable(); buildPreview(); saveDraft(); });
    document.getElementById('resetForm').addEventListener('click', ()=>{ document.getElementById('stokAwal').value=0; document.getElementById('stokMasuk').value=0; document.getElementById('terjual').value=0; document.getElementById('catatan').value=''; calcAkhir(); });
    document.getElementById('sendWA').addEventListener('click', ()=>{ buildPreview(); openWhatsApp(ADMIN_NUMBER, document.getElementById('waPreview').textContent); });
    document.getElementById('clearDay').addEventListener('click', ()=>{ localStorage.removeItem(keyForDate(document.getElementById('tanggal').value)); state.items.clear(); renderTable(); buildPreview(); });

    if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(()=>{}) ); }

    const storedBy = localStorage.getItem('so_byName')||'';
    if(storedBy) document.getElementById('byName').value = storedBy;
    document.getElementById('byName').addEventListener('input', (e)=> localStorage.setItem('so_byName', e.target.value));

    loadDraft(); buildPreview();
  </script>
</body>
</html>
